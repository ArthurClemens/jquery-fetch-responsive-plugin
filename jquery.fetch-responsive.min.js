/*
 *  Project: Fetch Responsive Image jQuery plugin
 *  Description: Mediator between user interface and webserver, with the goal to get images sized to match the current state of the interface.
 *  Version: 0.1.1
 *  Author: (c) 2014 Arthur Clemens arthurclemens@gmail.com
 *  License: MIT license
 *  URL: https://github.com/ArthurClemens/jquery-fetch-responsive-plugin
 */
 (function(h,k,s,i){var a="responsive",e,f,n=1,q="jquery-fetch-responsive",p={},t,g,b,j,l,c,m,r,u,o,v;function d(x,w){this.element=x;this.$element=h(x);this.options=h.extend({},h.fn[a].defaults,w);this._defaults=h.fn[a].defaults;this._name=a;this.init()}d.prototype.init=function(){var x,w;x=h.extend({},this.options,this.$element.data());m(x);if(x.range){o(x)}r(x);w=h.extend({},x);u(w);this.$element.attr("data-"+q,n);p[n++]={options:x,sendData:w,$el:this.$element};v();prepareUpdate(this.$element,x,w)};t=function(z,x,y){var A,w;A=y[z];if(A!==i&&A!==""){if(x==="integer"){w=g(A)}else{if(x==="float"){w=b(A)}else{if(x==="boolean"){w=j(A)}else{if(x==="range"){w=l(A)}else{if(x==="array"){w=c(A)}}}}}if(w!==i){y[z]=w}}};g=function(w){return parseInt(w,10)};b=function(w){return parseFloat(w,10)};j=function(w){return(w===true||w==="true"||w===1||w==="1")?true:false};l=function(x){if(typeof x==="object"&&x.min!==i&&x.max!==i){return x}else{var w=new RegExp(/(\d+)\s*[-, ]\s*(\d+)/).exec(x);return{min:parseInt(w[1],10),max:parseInt(w[2],10)}}};c=function(y){var x;if(Array.isArray(y)){x=y}else{x=y.split(/\s*,\s*/);if(x.length){for(var w=0;w<x.length;w++){x[w]=parseInt(x[w],10)}}}return x.sort(function(A,z){return z-A})};m=function(w){t("widths","array",w);t("mediaQuery","boolean",w);t("range","range",w);t("stepSize","integer",w);t("ratio","float",w)};r=function(w){delete w.stepSize;delete w.range};u=function(w){delete w.urlSource;delete w.range;delete w.stepSize;delete w.widths;delete w.ratio;delete w.update;delete w.getWidth;delete w.mediaQuery};o=function(x){var w,z,D,C,B=[],A;w=x.stepSize;z=x.range.max-x.range.min;D=Math.ceil(z/w);C=z/D;for(var y=0;y<=D;y++){A=x.range.min+y*C;B.push(parseInt(A,10))}x.widths=B.reverse()};v=function(){if(f){return}h(k).on("resize",function(){if(e){clearTimeout(e)}e=setTimeout(function(){handleResize()},h.responsive.resizeDelay)});f=true};stopListenForResize=function(){clearTimeout(e);h(k).off("resize");f=false};handleResize=function(){var w;for(var x in p){w=p[x];prepareUpdate(w.$el,w.options,w.sendData)}};prepareUpdate=function(B,z,y){var A,x,D,w;A=Math.round(h(k).width());if(z.mediaQuery){x=getMediaQuery();D=z.getWidth(B,y)}else{if(z.widths){D=widthForWidthList(z.widths,A);x=D.toString()}}if(needsUpdate(B,x)){if(w===i&&z.ratio){w=D/z.ratio}var C=h.extend({},y);C.sizeId=x;C.width=D;C.height=w;fetchData(B,z,C)}};widthForWidthList=function(y,x){var z=y[0];for(var w=1;w<y.length;w++){if(y[w]<x){break}z=y[w]}return z};needsUpdate=function(x,w){if(x.data("size-id")!==w){return true}return false};fetchData=function(z,y,w){var x;if(typeof(y.urlSource)==="function"){x=y.urlSource(w,z);handleReceivedUrl(z,x,y,w)}else{if(typeof(y.urlSource)==="string"){callServer(z,y.urlSource,y,w)}else{if(console){console.log("Invalid value for: url-source")}}}};callServer=function(z,w,y,x){h.ajax({url:w,type:"get",dataType:"json",data:{request:JSON.stringify(x)}}).done(function(B,C,A){if(B.error){if(console){console.log(B.error)}}else{handleReceivedUrl(z,B.url,y,x)}}).fail(function(A,C,B){if(console){console.log("Could not get url")}})};handleReceivedUrl=function(z,y,x,w){updateImageProperties(z,w.sizeId);if(x.update){x.update(z,h.extend({url:y},w))}else{updateImageSrc(z,y)}};updateImageSrc=function(x,w){if(x.is("img")){x.attr("src",w)}else{x.find("img").attr("src",w)}};updateImageProperties=function(x,w){x.data("size-id",w)};getMediaQuery=function(){var w;if(k.opera){w=k.getComputedStyle(s.body,":after").getPropertyValue("content")}else{if(k.getComputedStyle){w=k.getComputedStyle(s.head,null).getPropertyValue("font-family")}}return w};h.fn[a]=function(x){var w=arguments;if(x===i||typeof x==="object"){return this.each(function(){if(!h.data(this,"plugin_"+a)){h.data(this,"plugin_"+a,new d(this,x))}})}else{if(typeof x==="string"&&x[0]!=="_"&&x!=="init"){var y;this.each(function(){var z=h.data(this,"plugin_"+a);if(z instanceof d&&typeof z[x]==="function"){y=z[x].apply(z,Array.prototype.slice.call(w,1))}if(x==="destroy"){h.data(this,"plugin_"+a,null)}});return y!==i?y:this}}};h.fn[a].defaults={urlSource:i,range:i,stepSize:160,widths:i,ratio:i,update:i,getWidth:function(w,x){return parseInt(w.css("max-width"),10)||w.width()},mediaQuery:i};h[a]=function(w){h.extend(h.fn.responsive.defaults,w)};h[a].resizeDelay=500}(jQuery,window,document));