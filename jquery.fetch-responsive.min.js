/*
 *  Project: Fetch Responsive Image jQuery plugin
 *  Description: Mediator between user interface and webserver, with the goal to get images sized to match the current state of the interface.
 *  Version: 0.1.2
 *  Author: (c) 2014 Arthur Clemens arthurclemens@gmail.com
 *  License: MIT license
 *  URL: https://github.com/ArthurClemens/jquery-fetch-responsive-plugin
 */
(function(h,k,t,i){var a="responsive",e,f,o=1,r="jquery-fetch-responsive",q={},u,g,b,j,l,c,n,s,v,p,m,w;function d(y,x){this.element=y;this.$element=h(y);this.options=h.extend({},h.fn[a].defaults,x);this._defaults=h.fn[a].defaults;this._name=a;this.init()}d.prototype.init=function(){var y,x;y=h.extend({},this.options,this.$element.data());n(y);if(y.range){p(y)}s(y);x=h.extend({},y);v(x);this.$element.attr("data-"+r,o);q[o++]={options:y,sendData:x,$el:this.$element};w();prepareUpdate(this.$element,y,x)};u=function(A,y,z){var B,x;B=z[A];if(B!==i&&B!==""){if(y==="integer"){x=g(B)}else{if(y==="float"){x=b(B)}else{if(y==="boolean"){x=j(B)}else{if(y==="range"){x=l(B)}else{if(y==="array"){x=c(B)}}}}}if(x!==i){z[A]=x}}};g=function(x){return parseInt(x,10)};b=function(x){return parseFloat(x,10)};j=function(x){return(x===true||x==="true"||x===1||x==="1")?true:false};l=function(y){if(typeof y==="object"&&y.min!==i&&y.max!==i){return y}else{var x=new RegExp(/(\d+)\s*[-, ]\s*(\d+)/).exec(y);return{min:parseInt(x[1],10),max:parseInt(x[2],10)}}};c=function(z){var y;if(Array.isArray(z)){y=z}else{y=z.split(/\s*,\s*/);if(y.length){for(var x=0;x<y.length;x++){y[x]=parseInt(y[x],10)}}}return y.sort(function(B,A){return A-B})};n=function(x){u("widths","array",x);u("mediaQuery","boolean",x);u("range","range",x);u("stepSize","integer",x);u("ratio","float",x)};s=function(x){delete x.stepSize;delete x.range};v=function(x){delete x.urlSource;delete x.range;delete x.stepSize;delete x.widths;delete x.ratio;delete x.update;delete x.getWidth;delete x.mediaQuery};p=function(y){var x,A,E,D,C=[],B;x=y.stepSize;A=y.range.max-y.range.min;E=Math.ceil(A/x);D=A/E;for(var z=0;z<=E;z++){B=y.range.min+z*D;C.push(parseInt(B,10))}y.widths=C.reverse()};w=function(){if(f){return}h(k).on("resize",function(){if(e){clearTimeout(e)}e=setTimeout(function(){handleResize()},h.responsive.resizeDelay)});f=true};stopListenForResize=function(){clearTimeout(e);h(k).off("resize");f=false};handleResize=function(){var x;for(var y in q){x=q[y];prepareUpdate(x.$el,x.options,x.sendData)}};getHighResolutionValue=function(z,y,x){if(typeof z==="function"){return z(y,x)}else{if(z==="auto"){return h.responsive._detectedHighResolution}else{return j(z)}}};prepareUpdate=function(C,A,z){var B,y,E,x;B=Math.round(h(k).width());if(A.mediaQuery){y=getMediaQuery();E=A.getWidth(C,z)}else{if(A.widths){E=widthForWidthList(A.widths,B);y=E.toString()}}if(needsUpdate(C,y)){if(x===i&&A.ratio){x=E/A.ratio}var D=h.extend({},z);D.sizeId=y;D.width=E;D.height=x;if(A.highResolution!==i){D.highResolution=getHighResolutionValue(A.highResolution,D,C)}fetchData(C,A,D)}};widthForWidthList=function(z,y){var A=z[0];for(var x=1;x<z.length;x++){if(z[x]<y){break}A=z[x]}return A};needsUpdate=function(y,x){if(y.data("size-id")!==x){return true}return false};fetchData=function(A,z,x){var y;if(typeof(z.urlSource)==="function"){y=z.urlSource(x,A);handleReceivedUrl(A,y,z,x)}else{if(typeof(z.urlSource)==="string"){callServer(A,z.urlSource,z,x)}else{if(console){console.log("Invalid value for: url-source")}}}};callServer=function(A,x,z,y){h.ajax({url:x,type:"get",dataType:"json",data:{request:JSON.stringify(y)}}).done(function(C,D,B){if(C.error){if(console){console.log(C.error)}}else{handleReceivedUrl(A,C.url,z,y)}}).fail(function(B,D,C){if(console){console.log("Could not get url")}})};handleReceivedUrl=function(A,z,y,x){updateImageProperties(A,x.sizeId);if(y.update){y.update(A,h.extend({url:z},x))}else{updateImageSrc(A,z)}};updateImageSrc=function(y,x){if(y.is("img")){y.attr("src",x)}else{y.find("img").attr("src",x)}};updateImageProperties=function(y,x){y.data("size-id",x)};getMediaQuery=function(){var x;if(k.opera){x=k.getComputedStyle(t.body,":after").getPropertyValue("content")}else{if(k.getComputedStyle){x=k.getComputedStyle(t.head,null).getPropertyValue("font-family")}}return x};m=function(){return((k.matchMedia&&(k.matchMedia("only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)").matches||k.matchMedia("only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)").matches))||(k.devicePixelRatio&&k.devicePixelRatio>1.3))};h.fn[a]=function(y){var x=arguments;if(y===i||typeof y==="object"){return this.each(function(){if(!h.data(this,"plugin_"+a)){h.data(this,"plugin_"+a,new d(this,y))}})}else{if(typeof y==="string"&&y[0]!=="_"&&y!=="init"){var z;this.each(function(){var A=h.data(this,"plugin_"+a);if(A instanceof d&&typeof A[y]==="function"){z=A[y].apply(A,Array.prototype.slice.call(x,1))}if(y==="destroy"){h.data(this,"plugin_"+a,null)}});return z!==i?z:this}}};h.fn[a].defaults={urlSource:i,range:i,stepSize:160,widths:i,ratio:i,update:i,getWidth:function(x,y){return parseInt(x.css("max-width"),10)||x.width()},mediaQuery:i,highResolution:i};h[a]=function(x){h.extend(h.fn.responsive.defaults,x)};h[a].resizeDelay=500;h[a]._detectedHighResolution=m()}(jQuery,window,document));