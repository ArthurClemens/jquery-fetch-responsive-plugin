/*
 *  Project: Fetch Responsive Image jQuery plugin
 *  Description: Mediator between user interface and webserver, with the goal to get images sized to match the current state of the interface.
 *  Version: 0.1.3
 *  Author: (c) 2014 Arthur Clemens arthurclemens@gmail.com
 *  License: MIT license
 *  URL: https://github.com/ArthurClemens/jquery-fetch-responsive-plugin
 */
(function(i,l,u,j){var a="responsive",e,f,p=1,s="jquery-fetch-responsive",r={},v,h,b,k,m,c,g,o,t,w,q,n,x;function d(z,y){this.element=z;this.$element=i(z);this.options=i.extend({},i.fn[a].defaults,y);this._defaults=i.fn[a].defaults;this._name=a;this.init()}d.prototype.init=function(){var z,y;z=i.extend({},this.options,this.$element.data());o(z);if(z.range){q(z)}t(z);y=i.extend({},z);w(y);this.$element.attr("data-"+s,p);r[p++]={options:z,sendData:y,$el:this.$element};x();prepareUpdate(this.$element,z,y)};v=function(B,z,A){var C,y;C=A[B];if(C!==j&&C!==""){if(z==="integer"){y=h(C)}else{if(z==="float"){y=b(C)}else{if(z==="boolean"){y=k(C)}else{if(z==="range"){y=m(C)}else{if(z==="array"){y=c(C)}else{if(z==="highResolution"){y=g(C)}}}}}}if(y!==j){A[B]=y}}};h=function(y){return parseInt(y,10)};b=function(y){return parseFloat(y,10)};k=function(y){return(y===true||y==="true"||y===1||y==="1")?true:false};m=function(z){if(typeof z==="object"&&z.min!==j&&z.max!==j){return z}else{var y=new RegExp(/(\d+)\s*[-, ]\s*(\d+)/).exec(z);return{min:parseInt(y[1],10),max:parseInt(y[2],10)}}};c=function(A){var z;if(Array.isArray(A)){z=A}else{z=A.split(/\s*,\s*/);if(z.length){for(var y=0;y<z.length;y++){z[y]=parseInt(z[y],10)}}}return z.sort(function(C,B){return B-C})};g=function(y){if(y==="auto"){return i.responsive._detectedHighResolution}else{return k(y)}};o=function(y){v("widths","array",y);v("mediaQuery","boolean",y);v("range","range",y);v("stepSize","integer",y);v("ratio","float",y);v("highResolution","highResolution",y)};t=function(y){delete y.stepSize;delete y.range};w=function(y){delete y.urlSource;delete y.range;delete y.stepSize;delete y.widths;delete y.ratio;delete y.update;delete y.getWidth;delete y.mediaQuery;delete y.disableHighResolution};q=function(z){var y,B,F,E,D=[],C;y=z.stepSize;B=z.range.max-z.range.min;F=Math.ceil(B/y);E=B/F;for(var A=0;A<=F;A++){C=z.range.min+A*E;D.push(parseInt(C,10))}z.widths=D.reverse()};x=function(){if(f){return}i(l).on("resize",function(){if(e){clearTimeout(e)}e=setTimeout(function(){handleResize()},i.responsive.resizeDelay)});f=true};stopListenForResize=function(){clearTimeout(e);i(l).off("resize");f=false};handleResize=function(){var y;for(var z in r){y=r[z];prepareUpdate(y.$el,y.options,y.sendData)}};prepareUpdate=function(D,B,A){var C,z,F,y;C=Math.round(i(l).width());if(B.mediaQuery){z=getMediaQuery();F=B.getWidth(D,A)}else{if(B.widths){F=widthForWidthList(B.widths,C);z=F.toString()}}if(needsUpdate(D,z)){if(y===j&&B.ratio){y=F/B.ratio}var E=i.extend({},A);E.sizeId=z;E.width=F;E.height=y;if(B.disableHighResolution!==j){E.highResolution=E.highResolution&&!B.disableHighResolution(E,D)}fetchData(D,B,E)}};widthForWidthList=function(A,z){var B=A[0];for(var y=1;y<A.length;y++){if(A[y]<z){break}B=A[y]}return B};needsUpdate=function(z,y){if(z.data("size-id")!==y){return true}return false};fetchData=function(B,A,y){var z;if(typeof(A.urlSource)==="function"){z=A.urlSource(y,B);handleReceivedUrl(B,z,A,y)}else{if(typeof(A.urlSource)==="string"){callServer(B,A.urlSource,A,y)}else{if(console){console.log("Invalid value for: url-source")}}}};callServer=function(B,y,A,z){i.ajax({url:y,type:"get",dataType:"json",data:{request:JSON.stringify(z)}}).done(function(D,E,C){if(D.error){if(console){console.log(D.error)}}else{handleReceivedUrl(B,D.url,A,z)}}).fail(function(C,E,D){if(console){console.log("Could not get url")}})};handleReceivedUrl=function(B,A,z,y){updateImageProperties(B,y.sizeId);if(z.update){z.update(B,i.extend({url:A},y))}else{updateImageSrc(B,A)}};updateImageSrc=function(z,y){if(z.is("img")){z.attr("src",y)}else{z.find("img").attr("src",y)}};updateImageProperties=function(z,y){z.data("size-id",y)};getMediaQuery=function(){var y;if(l.opera){y=l.getComputedStyle(u.body,":after").getPropertyValue("content")}else{if(l.getComputedStyle){y=l.getComputedStyle(u.head,null).getPropertyValue("font-family")}}return y};n=function(){var y=l.devicePixelRatio||(l.matchMedia&&l.matchMedia("(min-resolution: 2dppx), (-webkit-min-device-pixel-ratio: 1.5),(-moz-min-device-pixel-ratio: 1.5),(min-device-pixel-ratio: 1.5)").matches?2:1)||1;return y>1.5};i.fn[a]=function(z){var y=arguments;if(z===j||typeof z==="object"){return this.each(function(){if(!i.data(this,"plugin_"+a)){i.data(this,"plugin_"+a,new d(this,z))}})}else{if(typeof z==="string"&&z[0]!=="_"&&z!=="init"){var A;this.each(function(){var B=i.data(this,"plugin_"+a);if(B instanceof d&&typeof B[z]==="function"){A=B[z].apply(B,Array.prototype.slice.call(y,1))}if(z==="destroy"){i.data(this,"plugin_"+a,null)}});return A!==j?A:this}}};i.fn[a].defaults={urlSource:j,range:j,stepSize:160,widths:j,ratio:j,update:j,getWidth:function(y,z){return parseInt(y.css("max-width"),10)||y.width()},mediaQuery:j,highResolution:j,disableHighResolution:j};i[a]=function(y){i.extend(i.fn.responsive.defaults,y)};i[a].resizeDelay=500;i[a]._detectedHighResolution=n()}(jQuery,window,document));